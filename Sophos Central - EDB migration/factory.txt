---
variables:
  - type: String
    name: JWT Token
    key: jwtToken
    required: true
    visible: true
    default: false
    description: |-
      This is the access token required to query the Sophos Central API.

      This is acquired in the "Sophos Central Auth & whoami" pipeline "get_token" step and passed to this pipeline.
  - type: String
    name: Output File
    key: outputFile
    required: true
    visible: true
    default: false
    description: |-
      The specific endpoint output file being processed by the current iteration of this pipeline.

      This is passed by the parent pipeline, which loops through all available output files.
    value: '{|each.item|}'
  - type: String
    name: Debug
    key: debug
    value: '{|vars.debug|}'
    required: true
    visible: true
    default: true
    description: 'Inherited from parent pipeline and If true, will enable debugs in this and all child pipelines for troubleshooting during runs.'
  - type: String
    name: Audit Mode
    key: auditMode
    value: '{|vars.auditMode|}'
    required: true
    visible: true
    default: true
    description: |-
      When enabled, any final action taken by the pipeline will not be run.

      This is primarily for proof of concept testing and development, but can be used for verification prior to a destructive action.

      Off by default
  - type: String
    name: Source Tenant ID
    key: srcTenantID
    required: false
    visible: true
    default: false
  - type: String
    name: Destination Tenant ID
    key: dstTenantID
    required: false
    visible: true
    default: false
steps:
  - id: END_dumpVars
    name: 'End [Migrate]'
    type: debug
    depends:
      - checkMigrationStatus
    properties:
      message: '{|vars | dump(2)|}'
    condition: '{|vars.debug == "true"|}'
  - id: START_dumpVars
    name: 'Start [Migrate]'
    type: debug
    depends: []
    properties:
      message: '{|vars | dump(2)|}'
    condition: '{|vars.debug == "true"|}'
  - id: createMigration
    name: '[Library] [Endpoint] Endpoint Action'
    type: pipeline
    depends:
      - START_dumpVars
    properties:
      pipeline_id: 63cef472980e48b584748c5c
      pipeline_revision_id: latest
      variables:
        jwtToken: '{|vars.jwtToken|}'
        fullUrl: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+vars.dstTenantID+''`].apiRegion | [0]'')+"/endpoint/v1/migrations"|}'
        tenantID: '{|vars.dstTenantID|}'
        endpointID: '{|each.item.id|}'
        hostName: '{|each.item.hostname|}'
        tenantName: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+each.item.tenant.id+''`].tenantName | [0]'')|}'
        httpSuccessCode: 201
        httpApiMethod: POST
        httpApiBody: |-
          {|'{'+'"fromTenant": "' + vars.srcTenantID + '" ,' +
          '"endpoints":' + (read_file('migrate.json') | parse_json() | json_query('[].id') | dump) + '}'|}
        debug: '{|vars.debug|}'
        auditMode: '{|vars.auditMode|}'
    each: '{|read_file(vars.outputFile) | parse_json()|}'
  - id: triggerMigration
    name: '[Library] [Endpoint] Endpoint Action'
    type: pipeline
    depends:
      - createMigration
    properties:
      pipeline_id: 63cef472980e48b584748c5c
      pipeline_revision_id: latest
      variables:
        jwtToken: '{|vars.jwtToken|}'
        fullUrl: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+vars.srcTenantID+''`].apiRegion | [0]'')+"/endpoint/v1/migrations/" + steps.createMigration.result.outputs.fullResponse.body.id|}'
        tenantID: '{|vars.srcTenantID|}'
        endpointID: 'null'
        hostName: 'null'
        tenantName: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+each.item.tenant.id+''`].tenantName | [0]'')|}'
        httpSuccessCode: 201
        httpApiMethod: PUT
        httpApiBody: |-
          {|'{'+'"id": "' + steps.createMigration.result.outputs.fullResponse.body.id + '" ,' +
          '"token": "' + steps.createMigration.result.outputs.fullResponse.body.token + '",' +
          '"endpoints":' + (read_file('migrate.json') | parse_json() | json_query('[].id') | dump) + '}'|}
        debug: '{|vars.debug|}'
        auditMode: '{|vars.auditMode|}'
  - id: checkMigrationStatus
    name: '[Library] [Endpoint] Endpoint Action'
    type: pipeline
    depends:
      - triggerMigration
    properties:
      pipeline_id: 63cef472980e48b584748c5c
      pipeline_revision_id: latest
      variables:
        jwtToken: '{|vars.jwtToken|}'
        fullUrl: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+vars.srcTenantID+''`].apiRegion | [0]'')+"/endpoint/v1/migrations/" + steps.createMigration.result.outputs.fullResponse.body.id + "/endpoints"|}'
        tenantID: '{|vars.srcTenantID|}'
        endpointID: 'null'
        hostName: 'null'
        tenantName: '{|read_file(''tenants.json'') | parse_json() | json_query(''[?id==`''+each.item.tenant.id+''`].tenantName | [0]'')|}'
        httpSuccessCode: 200
        httpApiMethod: GET
        debug: '{|vars.debug|}'
        auditMode: '{|vars.auditMode|}'
    condition: '{|vars.auditMode == "false"|}'
outputs:
  - key: apiStatus
    value: '{|steps.setTamperOn.results|}'
layout:
  elements:
    - id: END_dumpVars
      position:
        x: -405
        'y': 35
      links:
        - sourceId: checkMigrationStatus
          sourcePort: bottom
          targetPort: top
          vertices: []
    - id: START_dumpVars
      position:
        x: -405
        'y': -300
      links: []
    - id: createMigration
      position:
        x: -405
        'y': -205
      links:
        - sourceId: START_dumpVars
          sourcePort: bottom
          targetPort: top
          vertices: []
      icon_name: book
    - id: triggerMigration
      position:
        x: -405
        'y': -125
      links:
        - sourceId: createMigration
          sourcePort: bottom
          targetPort: top
          vertices: []
      icon_name: book
    - id: checkMigrationStatus
      position:
        x: -405
        'y': -45
      links:
        - sourceId: triggerMigration
          sourcePort: bottom
          targetPort: top
          vertices: []
      icon_name: book









checkMigrationStatus








SRC 
05779962-e855-41ae-9338-6cbf6a73a211
NYC

DST 
85a183fe-b633-46b8-8d66-6394ba8a8590
MIG